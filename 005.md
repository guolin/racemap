# 航线类型完整需求文档

## 概述
基于比赛需求，计划完善四种标准航线类型：Windward-Leeward（迎尾风）、Triangle（三角形）、iQFoil Slalom（障碍滑航）和 Optimist Trapezoid（OP梯形），以支持各种类型的帆船比赛。

## 现状分析
当前系统已有航线类型：
- `simple`: 简单轴向+距离航线（基础上风航线）
- `simple1a`: 简单航线变体
- `oneFour`: 包含4号标记的航线
- `ioTrapezoid`: IO梯形航线

需要标准化为国际通用的航线类型。

## 一、Windward-Leeward Course（迎尾风航线）

### 背景
- 最经典的帆船比赛航线，俗称"香肠"航线
- 奥运会、美洲杯等顶级赛事的标准配置
- 强调上风（windward）和下风（leeward）的基础航行技能
- 直上直下的航线设计，测试纯粹的迎风和顺风技术

### 场地特点
- **简洁高效**: 两个主要标记点，航线清晰明了
- **技能纯粹**: 专注迎风和顺风航行，无横风干扰
- **比赛节奏**: 通常12-14分钟一轮，每天可进行10场比赛
- **风况适应**: 适用于7-30节风力范围

### 设置参数
```typescript
interface WindwardLeewardParams {
  windwardDistance: number;    // 上风距离 (海里) - 默认: 1.0
  startLineLength: number;     // 起航线长度 (米) - 默认: 150
  gateWidth: number;          // 下风门宽度 (米) - 默认: 100
  laps: number;               // 圈数 - 默认: 2
  finishType: 'windward' | 'leeward';  // 终点位置 - 默认: 'windward'
  offsetMark: boolean;        // 是否使用偏移标记 - 默认: true
  offsetDistance: number;     // 偏移距离 (米) - 默认: 50
}
```

### 渲染要求
- 起航线：委员会船 + 起航标记
- 上风标记（Mark 1）+ 可选偏移标记
- 下风门（Mark 4a, 4b）：两个标记组成的门
- 航路指示线：直上直下
- 终点线：通常在上风标记处

### 英文标准术语
- **Course Type**: Windward-Leeward Course (W/L)
- **Marks**: Windward Mark, Leeward Gate, Offset Mark
- **Finish**: Windward Finish / Leeward Finish

---

## 二、Triangle Course（三角形航线）

### 背景
- 传统的三角形航线，历史悠久
- 测试选手的全方位航行能力：迎风、顺风、横风
- 适合传统帆船比赛和训练使用
- 奥林匹克三角形的简化版本

### 场地特点
- **全面技能**: 包含所有航向的航行技术
- **战术丰富**: 三个标记点提供更多战术选择
- **横风考验**: 特别测试横风（reaching）航行能力
- **经典配置**: 等边三角形，每个角60度

### 设置参数
```typescript
interface TriangleParams {
  sideLength: number;         // 边长 (海里) - 默认: 1.0
  startLineLength: number;    // 起航线长度 (米) - 默认: 150
  triangleType: 'equilateral' | 'windward-reaching';  // 三角形类型 - 默认: 'equilateral'
  windwardAngle: number;      // 上风角度 (度) - 默认: 0 (正迎风)
  laps: number;              // 圈数 - 默认: 1
  direction: 'port' | 'starboard';  // 绕行方向 - 默认: 'port'
  finishType: 'windward' | 'leeward' | 'reaching';  // 终点位置 - 默认: 'windward'
}
```

### 渲染要求
- 起航线：委员会船 + 起航标记
- 三个主要标记（Mark 1, 2, 3）
- 航路连接线显示绕行方向
- 终点线：可选择在任一标记处
- 方向箭头指示

### 英文标准术语
- **Course Type**: Triangle Course
- **Marks**: Windward Mark, Reaching Mark, Leeward Mark
- **Direction**: Port Rounding / Starboard Rounding

---

## 三、iQFoil Slalom Course（障碍滑航航线）

### 背景
- iQFoil 是奥运会水翼帆板项目，包含障碍赛（obstacle/slalom racing）
- 根据风况选择不同赛制：航线赛、障碍赛、马拉松赛
- 在 6-11 节风力下使用滑航障碍航线，最大化帆力以实现水翼起飞

### 场地特点
- **障碍滑航设置**: 多个门标记组成的 S 型路径
- **左右路径分离**: 左舷（port）和右舷（starboard）选手走不同路径
- **门序列**: 通常3-4分钟的短距离滑航，包含1-3次转向
- **动态调整**: 根据风向和风力实时调整标记位置
- **快速转向**: 强调高速通过标记点的技巧和水翼起飞

### 参数需求
```typescript
interface IqfoilCourseParams {
  gateCount: number;        // 门数 (通常2-3个)
  gateWidth: number;        // 门宽度 (米)
  gateSpacing: number;      // 门间距 (米)
  startOffset: number;      // 起始偏移距离
  finishType: 'gate' | 'line';  // 终点类型
  pattern: 'slalom';        // 滑航模式
  sideLayout: {             // 左右路径布局
    portSide: Array<{       // 左舷路径门序列
      gateNumber: number;
      angle: number;        // 相对风向角度
      distance: number;     // 距离起点距离
    }>;
    starboardSide: Array<{  // 右舷路径门序列
      gateNumber: number;
      angle: number;
      distance: number;
    }>;
  };
  windConditions: '5-10' | '7-15';  // 适用风况 (节)
}
```

### 渲染要求
- 起始线（中央统一起点）
- 左舷路径：左侧门序列，用红色标记
- 右舷路径：右侧门序列，用绿色标记  
- 每个门由两个浮标组成，显示门号
- 路径指示线：左右分叉的推荐航线
- 终点线：左右路径汇合的终点
- 风向指示器

### 战术考虑
- **右舷优先权**: 右舷抢风船只有路权优势
- **门选择**: 选手可根据风况和位置选择左右路径
- **超越机会**: 在门之间提供超越空间
- **拥堵避免**: 左右分离减少起点拥堵

## 四、Optimist Trapezoid Course（OP梯形航线）

### 背景
- Optimist 是青少年帆船入门级别
- 使用经典的梯形航线（Trapezoid Course）
- 2008年奥运会建立的标准梯形参考系统

### 场地特点
- **标准梯形**: 60度或70度梯形航线
- **4号门参考**: 以4号门中心为参考点进行布置
- **委员会船终点**: 使用委员会船作为终点线

### 设置参数
```typescript
interface OptimistTrapezoidParams {
  trapezoidAngle: 60 | 70;    // 梯形角度 (度) - 默认: 60
  windwardDistance: number;    // 上风距离 (海里) - 默认: 0.8
  gateWidth: number;          // 4号门宽度 (米) - 默认: 80
  startLineLength: number;    // 起航线长度 (米) - 默认: 120
  finishType: 'committee' | 'windward';  // 终点类型 - 默认: 'committee'
  laps: number;               // 圈数 - 默认: 1
  useOffsetMark: boolean;     // 是否使用偏移标记 - 默认: true
  offsetDistance: number;     // 偏移距离 (米) - 默认: 40
}
```

### 渲染要求
- 5个标记点（Mark 1, 2, 3, 4a, 4b）
- 起航线：委员会船 + 起航标记
- 4号门：两个标记组成的下风门
- 可选偏移标记（1号标记旁）
- 梯形航路连接线
- 委员会船终点线

### 英文标准术语
- **Course Type**: Optimist Trapezoid Course (OTC)
- **Marks**: Windward Mark (1), Reaching Marks (2,3), Leeward Gate (4a,4b)
- **Reference**: Gate 4 Center Point System
- **Finish**: Committee Boat Finish

---

## 技术实现方案

### 插件架构扩展
- 在 `src/features/course/plugins/` 下创建新插件文件
- 实现 `CoursePlugin` 接口
- 在 `registry.ts` 中注册新插件

### 参数表单自动生成
- 利用现有的动态表单系统
- 为每种航线类型定义参数模式
- 支持条件显示和验证

### 地图渲染优化
- 扩展 `useCourseDraw` hook
- 支持复杂的多标记渲染
- 添加路径指示线和标记编号

### MQTT 消息格式兼容
- 保持现有消息结构
- 在 `course.params` 中添加新的参数类型
- 确保向后兼容性

## 插件 ID 和命名规范

### 新增插件 ID
```typescript
type CourseTypeId = 
  | 'windwardLeeward'     // 迎尾风航线
  | 'triangle'           // 三角形航线  
  | 'iqfoilSlalom'       // iQFoil障碍滑航
  | 'optimistTrapezoid'  // OP梯形航线
  | 'simple'             // 现有: 简单航线
  | 'simple1a'           // 现有: 简单航线变体
  | 'oneFour'            // 现有: 包含4号标记
  | 'ioTrapezoid';       // 现有: IO梯形
```

### 国际化配置示例
```typescript
// windwardLeeward 插件的 i18n 配置
i18n: {
  zh: {
    name: '迎尾风航线 (W/L)',
    labels: {
      windwardDistance: '上风距离 (海里)',
      startLineLength: '起航线长度 (米)',
      gateWidth: '下风门宽度 (米)',
      laps: '圈数',
      finishType: '终点位置',
      offsetMark: '使用偏移标记',
      offsetDistance: '偏移距离 (米)'
    },
    tooltips: {
      windwardMark: '上风标记',
      leewardGate: '下风门',
      offsetMark: '偏移标记',
      committeeBoot: '委员会船'
    }
  },
  en: {
    name: 'Windward-Leeward Course',
    labels: {
      windwardDistance: 'Windward Distance (NM)',
      startLineLength: 'Start Line Length (m)',
      gateWidth: 'Leeward Gate Width (m)',
      laps: 'Number of Laps',
      finishType: 'Finish Location',
      offsetMark: 'Use Offset Mark',
      offsetDistance: 'Offset Distance (m)'
    },
    tooltips: {
      windwardMark: 'Windward Mark',
      leewardGate: 'Leeward Gate',
      offsetMark: 'Offset Mark',
      committeeBoot: 'Committee Boat'
    }
  }
}
```

## 开发优先级和计划

### 第一阶段：标准化现有航线
1. **重构 `simple` 为 `windwardLeeward`**: 添加下风门、多圈支持
2. **完善参数默认值**: 按国际标准设定默认参数

### 第二阶段：新增核心航线  
3. **添加 `triangle` 航线**: 经典三角形配置
4. **添加 `optimistTrapezoid`**: 青少年标准梯形

### 第三阶段：专业级航线
5. **添加 `iqfoilSlalom`**: 奥运水翼帆板障碍滑航

### 兼容性处理
- 保持现有 `simple`、`oneFour` 等插件向后兼容
- 在界面中标注"经典"或"标准"航线类型
- 提供航线类型迁移工具

---

*注: 本文档基于网络搜索和现有代码架构分析，具体实现时需要参考官方比赛规则和技术文档进行细化调整。*