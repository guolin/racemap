# 帆船裁判应用需求文档

## 1. 页面描述

### 1.1 首页
- 包含两个按钮：加入一场比赛和管理比赛。
- **加入一场比赛**：显示之前加入过的比赛列表，使用本地缓存保存。
- **管理比赛**：显示之前管理的比赛列表，可以选择或创建一个新比赛，创建时生成一个4位数字代码。

### 1.2 管理人员的比赛页面
- 显示地图，展示比赛航线的角度（风的角度）和场地的距离（起航线到1标的距离）。
- 地图上方显示当前手机指南针的角度（磁北）。

### 1.3 航线设置页面
- 管理人员可以从比赛页面进入。
- 包括设置角度、距离和启航线距离。

### 1.4 裁判的比赛页面
- 显示比赛地图。
- 包含一个按钮，可以设置目标位置（如1标或启航标），选择后显示到达该标的方向和角度。

### 1.5 地图页面
- 右下角有加减缩放按钮。
- 左上角在导航栏下方有一个指南针按钮，点击可以指向北方向。

### 1.6 航向描述
- 启航船位于起航线左侧。
- 垂直风向的另一侧是启航标，中间是起航线，需要画一条线。
- 垂直于起航线，面向风的方向，距离（航线距离）的位置是1标。

## 2. 页面之间的转换
- 从**首页**可以选择加入或管理比赛。
- 在**管理比赛**中可以创建或选择比赛，进入**管理人员的比赛页面**。
- 在**管理人员的比赛页面**可以进入**航线设置页面**。
- **裁判的比赛页面**提供目标位置设置功能。

## 3. 用户角色

### 3.1 裁判长
- 创建比赛或房间
- 设置比赛场地
- 确定裁判船位置（通过地图或GPS）
- 设置航线（如迎顺风航线）

### 3.2 普通裁判
- 参与比赛管理

## 4. 功能需求

### 4.1 比赛创建
- 裁判长可以创建比赛或房间
- 设置比赛名称、时间、地点

### 4.2 裁判船位置设置
- 通过地图选择位置
- 使用GPS当前位置作为裁判船位置

### 4.3 航线设置
- 设置风向（如0度）
- 设置起航线（启航船左侧，风向成90度）
- 设置一标和四标的距离（如0.5海里）

### 4.4 地图显示
- 在地图上显示比赛场地
- 标记启航船、裁判船、一标、四标

## 5. 界面设计
- 用户友好的界面
- 清晰的导航和设置选项

## 6. 技术需求
- 支持GPS定位
- 地图集成

## 7. 其他
- 支持多语言
- 数据安全和隐私保护

## 8. 实时位置同步（MQTT）

### 8.1 功能描述
- **管理员（裁判长）**：只要设备在线，就以固定间隔（如 1~2 秒）通过 MQTT 发布自己的实时 GPS 位置（纬度、经度、高度、速度、航向等信息）。
- **普通裁判**：订阅对应比赛的 MQTT Topic，实时接收管理员发布的位置信息，并在地图上以标记或图标的形式展示。

### 8.2 Topic 设计
| 角色 | Topic 格式 | 示例 |
| ---- | ---------- | ---- |
| 发布 | `race/{courseId}/location/admin` | `race/ABCD/location/admin` |
| 订阅 | `race/{courseId}/location/#` | `race/ABCD/location/#` |

### 8.3 数据格式（JSON）
```json
{
  "id": "ADMIN",          // 发送者身份
  "lat": 31.229221,        // 纬度
  "lng": 121.476419,       // 经度
  "heading": 45,          // 船头朝向 (度)
  "speed": 3.2,           // 船速 (节)
  "timestamp": 1688888888 // Unix 时间戳 (ms)
}
```

### 8.4 服务器选型
- 开发及测试阶段可使用免费公共 MQTT Broker，例如：
  1. `mqtt.eclipseprojects.io`（Eclipse Mosquitto 公共服务，支持 MQTT v3.1/v3.1.1，1883 端口，无用户名密码）
  2. `broker.emqx.io`（EMQX 公共服务，1883/8883，支持 WebSocket）
- 生产环境建议自建或购买商业服务，以确保可靠性与安全性。

### 8.5 客户端实现
- 前端使用 `mqtt.js` 或 `@taoqf/react-native-mqtt` 等库连接 Broker。
- 采用 **QoS 0**（尽最大努力传输）降低延迟。
- 断线重连及心跳保持。

### 8.6 安全与隐私
- 仅广播相对公开的裁判船位置信息，不包含个人隐私。
- 生产环境可开启 TLS/SSL、用户名密码或 Token 鉴权。 