# æµ·ä¸Šç¨³å®šæ€§ä¼˜åŒ–å’Œæ¶æ„ç®€åŒ–æ–¹æ¡ˆ

## æ¦‚è¿°

é’ˆå¯¹æµ·ä¸Šä¿¡å·ä¸ç¨³å®šç¯å¢ƒï¼Œé‡æ–°æ¢³ç†ç³»ç»Ÿæ¶æ„ï¼Œè§£å†³åœ¨çº¿ç»Ÿè®¡æ··ä¹±é—®é¢˜ï¼Œå¢å¼º MQTT/GPS ç¨³å®šæ€§ï¼ŒåŒæ—¶ç®€åŒ–éæ ¸å¿ƒåŠŸèƒ½ã€‚

## æ ¸å¿ƒåŸåˆ™

1. **å¯é æ€§ä¼˜å…ˆ** - æµ·ä¸Šç¯å¢ƒä¸å…è®¸å¤±è´¥
2. **é€»è¾‘ç»Ÿä¸€** - é¿å…ç®¡ç†å‘˜/è§‚å¯Ÿè€…åŒé‡æœºåˆ¶
3. **ç®€åŒ–éæ ¸å¿ƒ** - ä¸“æ³¨ç¨³å®šæ€§ï¼Œç§»é™¤è¿‡åº¦è®¾è®¡

## ä¸»è¦é—®é¢˜åˆ†æ

### ğŸš¨ åœ¨çº¿ç»Ÿè®¡é€»è¾‘æ··ä¹±
- **ç®¡ç†å‘˜ä¸åœ¨ç»Ÿè®¡ä¸­** - å‘å¸ƒåˆ°ä¸åŒä¸»é¢˜ (`admin` vs `observer/*`)
- **è‡ªå·±ä¸åœ¨ç»Ÿè®¡ä¸­** - `useObserversPos` è·³è¿‡è‡ªå·±çš„æ¶ˆæ¯
- **æ¸…ç†æœºåˆ¶ä¸ä¸€è‡´** - ç®¡ç†å‘˜5åˆ†é’ŸTTL vs è§‚å¯Ÿè€…60ç§’æ¸…ç†
- **ç»“æœé”™è¯¯** - 1ç®¡ç†å‘˜+2è§‚å¯Ÿè€…æ˜¾ç¤º1äººåœ¨çº¿

### ğŸš¨ MQTT ç¨³å®šæ€§ä¸è¶³
- **é‡è¿é™åˆ¶è¿‡ä¸¥** - 5æ¬¡é‡è¿åæ°¸ä¹…æ”¾å¼ƒ
- **é‡è¿é—´éš”è¿‡çŸ­** - 2ç§’é—´éš”æ¶ˆè€—ç”µé‡
- **æµ·ä¸Šåœºæ™¯ä¸é€‚é…** - ä¿¡å·å¯èƒ½æ–­è¿å¾ˆä¹…

### ğŸš¨ GPS ç²¾åº¦è¦æ±‚ä¸ä¸¥
- **æ— ç²¾åº¦è¿‡æ»¤** - å¯èƒ½æ¥å—ä½ç²¾åº¦æ•°æ®
- **è¶…æ—¶è®¾ç½®ä¿å®ˆ** - 10ç§’å¯¹æµ·ä¸ŠGPSåçŸ­

## è§£å†³æ–¹æ¡ˆ

### 1. ç»Ÿä¸€åœ¨çº¿çŠ¶æ€ç®¡ç† ğŸ¯

#### æ–°çš„ä¸»é¢˜ç»“æ„
```
æ—§: race/{raceId}/location/admin          (ç®¡ç†å‘˜)
æ—§: race/{raceId}/location/observer/{id}  (è§‚å¯Ÿè€…)

æ–°: race/{raceId}/presence/{userId}       (æ‰€æœ‰äººç»Ÿä¸€)
```

#### ç»Ÿä¸€æ¶ˆæ¯æ ¼å¼
```typescript
{
  id: "ADMIN" | "observer_xxx",
  role: "admin" | "observer",
  lat: number,
  lng: number,
  heading?: number,
  course?: { type: string, params: any }, // ä»…ç®¡ç†å‘˜
  ts: number
}
```

#### å®æ–½æ–‡ä»¶

**1. ä¿®æ”¹ç®¡ç†å‘˜å‘å¸ƒ** - `src/features/mqtt/hooks/useMqttPosSync.ts`
```typescript
// ç¬¬18è¡Œï¼Œä¿®æ”¹topicå‡½æ•°
const presenceTopic = (id: string) => `race/${id}/presence/ADMIN`;

// ç¬¬99è¡Œï¼Œä¿®æ”¹å‘å¸ƒé€»è¾‘
const payloadStr = JSON.stringify({
  id: 'ADMIN',
  role: 'admin',
  lat: pos.lat,
  lng: pos.lng,
  course: { type, params },
  ts: now
});
client.publish(presenceTopic(courseId), payloadStr, { retain: true, qos: 1 });
```

**2. ä¿®æ”¹è§‚å¯Ÿè€…å‘å¸ƒ** - `src/features/mqtt/service.ts`
```typescript
// ç¬¬92-111è¡Œï¼Œä¿®æ”¹ publishObserverPos å‡½æ•°
export function publishObserverPos(raceId: string, observerId: string, pos: ObserverPosition) {
  const c = getMqttClient();
  if (!c || !c.connected) return;

  const topic = `race/${raceId}/presence/${observerId}`;
  const payload = JSON.stringify({
    id: observerId,
    role: 'observer',
    lat: pos.lat,
    lng: pos.lng,
    heading: pos.heading,
    ts: Date.now()
  });

  c.publish(topic, payload, {
    qos: 0,
    retain: true,
    properties: { messageExpiryInterval: 60 } // ç»Ÿä¸€60ç§’è¿‡æœŸ
  });
}
```

**3. æ–°å»ºç»Ÿä¸€çš„åœ¨çº¿ç”¨æˆ·Hook** - `src/features/mqtt/hooks/useOnlineUsers.ts`
```typescript
import { useEffect, useState } from 'react';
import { useMqttClient } from '../hooks';

export interface OnlineUser {
  id: string;
  role: 'admin' | 'observer';
  lat: number;
  lng: number;
  heading?: number;
  course?: { type: string; params: any };
  ts: number;
}

export function useOnlineUsers(raceId: string, currentUserId: string) {
  const client = useMqttClient();
  const [users, setUsers] = useState<Record<string, OnlineUser>>({});

  useEffect(() => {
    if (!client) return;

    const topicFilter = `race/${raceId}/presence/+`;

    const onMsg = (topic: string, payload: Uint8Array) => {
      try {
        const userId = topic.split('/').pop()!;
        const data = JSON.parse(new TextDecoder().decode(payload));

        setUsers(prev => {
          const now = Date.now();
          // ç»Ÿä¸€60ç§’è¿‡æœŸæ¸…ç†
          const cleaned: Record<string, OnlineUser> = {};
          Object.entries(prev).forEach(([id, user]) => {
            if (now - user.ts < 60_000) {
              cleaned[id] = user;
            }
          });

          // æ·»åŠ /æ›´æ–°ç”¨æˆ·ï¼ˆåŒ…æ‹¬è‡ªå·±ï¼‰
          cleaned[userId] = {
            id: data.id,
            role: data.role,
            lat: data.lat,
            lng: data.lng,
            heading: data.heading,
            course: data.course,
            ts: data.ts
          };

          return cleaned;
        });
      } catch (e) {
        console.error('[useOnlineUsers] Parse error:', e);
      }
    };

    client.subscribe(topicFilter, { qos: 0 });
    client.on('message', onMsg);

    return () => {
      client.unsubscribe(topicFilter);
      client.off('message', onMsg);
    };
  }, [client, raceId]);

  const allUsers = Object.values(users);
  return {
    allUsers,
    onlineCount: allUsers.length,
    otherUsers: allUsers.filter(u => u.id !== currentUserId),
    admin: allUsers.find(u => u.role === 'admin'),
    observers: allUsers.filter(u => u.role === 'observer')
  };
}
```

**4. æ›´æ–° RaceMap ç»„ä»¶** - `src/features/map/RaceMap.tsx`
```typescript
// ç¬¬263-270è¡Œï¼Œæ›¿æ¢ç°æœ‰é€»è¾‘
import { useOnlineUsers } from '@features/mqtt/hooks/useOnlineUsers';

// æ›¿æ¢ useObserversPos ä¸ºæ–°çš„ç»Ÿä¸€hook
const { allUsers, onlineCount, otherUsers, admin } = useOnlineUsers(
  courseId, 
  isAdmin ? 'ADMIN' : observerIdRef.current
);

// ç¬¬295è¡Œï¼Œä¿æŒç°æœ‰æ˜¾ç¤ºé€»è¾‘
right={<OnlineCount count={onlineCount} />}

// ç¬¬305è¡Œï¼Œæ›´æ–°è§‚å¯Ÿè€…åˆ—è¡¨
<ObserversList observers={otherUsers} currentObserverId={isAdmin ? 'ADMIN' : observerIdRef.current} />
```

### 2. å¼ºåŒ– MQTT ç¨³å®šæ€§ ğŸ”§

**æ–‡ä»¶**: `src/features/mqtt/service.ts`

```typescript
// ç¬¬29-38è¡Œï¼Œä¼˜åŒ–è¿æ¥å‚æ•°
const options: IClientOptions = {
  reconnectPeriod: 8000,   // 8ç§’é‡è¿é—´éš”ï¼Œé¿å…é¢‘ç¹é‡è¿
  connectTimeout: 15000,   // 15ç§’è¿æ¥è¶…æ—¶
  keepalive: 30,           // 30ç§’å¿ƒè·³ï¼ŒèŠ‚çœæµé‡
  clean: true,
  clientId: `rc_${Math.random().toString(16).slice(2, 10)}`,
  username: process.env.NEXT_PUBLIC_MQTT_USERNAME,
  password: process.env.NEXT_PUBLIC_MQTT_PASSWORD,
  protocolVersion: 5,
};

// ç¬¬47-53è¡Œï¼Œç§»é™¤é‡è¿é™åˆ¶
c.on('reconnect', () => {
  console.warn('[MQTT] reconnectingâ€¦ count:', ++reconnectCount);
  // âŒ åˆ é™¤è¿™æ®µä»£ç ï¼Œå…è®¸æ— é™é‡è¿
  // if (reconnectCount > 5) {
  //   console.error('[MQTT] too many reconnection attempts, closing connection');
  //   c.end(true);
  //   client = null;
  // }
});
```

### 3. å¼ºåŒ– GPS ç²¾åº¦æ§åˆ¶ ğŸ¯

**æ–‡ä»¶**: `src/features/map/hooks/useGpsWatch.ts`

```typescript
// ç¬¬75-79è¡Œï¼Œä¼˜åŒ–GPSé…ç½®
watchIdRef.current = navigator.geolocation.watchPosition(handler, errorHandler, {
  enableHighAccuracy: true,
  maximumAge: 0,          // ä¸å…è®¸ç¼“å­˜ï¼Œç¡®ä¿æ•°æ®æ–°é²œ
  timeout: 20000,         // 20ç§’è¶…æ—¶ï¼Œç»™æµ·ä¸ŠGPSæ›´å¤šæ—¶é—´
});

// ç¬¬40è¡Œåï¼Œæ·»åŠ ç²¾åº¦è¿‡æ»¤
const handler = (pos: GeolocationPosition) => {
  const { latitude, longitude, heading, speed, accuracy } = pos.coords as GeolocationCoordinates & { heading: number };
  
  // ä¸¥æ ¼ç²¾åº¦è¦æ±‚ï¼šæ‹’ç»ä½ç²¾åº¦æ•°æ®
  if (accuracy && accuracy > 10) {
    console.debug('[GPS] Position rejected: accuracy', accuracy, 'm');
    return; // æ²¡æœ‰æ•°æ®å¥½è¿‡é”™è¯¯æ•°æ®
  }
  
  // åˆç†æ€§æ£€æŸ¥ï¼šé˜²æ­¢GPSè·³ç‚¹
  if (lastLatLngRef.current) {
    const distance = lastLatLngRef.current.distanceTo(L.latLng(latitude, longitude));
    if (distance > 500) { // 500ç±³è·³è·ƒæ£€æµ‹
      console.debug('[GPS] Position rejected: unrealistic jump', distance, 'm');
      return;
    }
  }

  const latlng = L.latLng(latitude, longitude);
  // ... å…¶ä½™é€»è¾‘ä¿æŒä¸å˜
};

// ç¬¬71-73è¡Œï¼Œä¼˜åŒ–é”™è¯¯å¤„ç†
const errorHandler = (err: GeolocationPositionError) => {
  let errorMessage = '';
  switch (err.code) {
    case 1: errorMessage = 'GPSæƒé™è¢«æ‹’ç»ï¼Œè¯·åœ¨è®¾ç½®ä¸­å…è®¸ä½ç½®è®¿é—®'; break;
    case 2: errorMessage = 'GPSä¿¡å·å¼±ï¼Œè¯·ç§»åŠ¨åˆ°å¼€é˜”ä½ç½®'; break;
    case 3: errorMessage = 'GPSå®šä½è¶…æ—¶ï¼Œè¯·æ£€æŸ¥GPSè®¾ç½®'; break;
    default: errorMessage = `GPSé”™è¯¯: ${err.message}`;
  }
  setState((s) => ({ ...s, ok: false, errorMsg: errorMessage }));
};
```

### 4. æ¶æ„ç®€åŒ– âœ‚ï¸

#### åˆ é™¤è¿‡åº¦è®¾è®¡
1. **å¤šè¯­è¨€ç³»ç»Ÿç®€åŒ–** - åˆ é™¤ `CoursePluginI18n`ï¼Œæ”¹ä¸ºç®€å•å¯¹è±¡æ˜ å°„
2. **UIåº“ç²¾ç®€** - ç§»é™¤ `next-themes`ï¼Œä¿ç•™æ ¸å¿ƒ shadcn/ui ç»„ä»¶
3. **Hookæ•´åˆ** - åˆå¹¶ç›¸å…³åŠŸèƒ½ï¼Œå‡å°‘æ–‡ä»¶æ•°é‡

#### ä¿ç•™å¿…è¦è®¾è®¡
1. **èˆªçº¿æ’ä»¶ç³»ç»Ÿ** - 10ä¸ªèˆªçº¿ç±»å‹éœ€è¦é…ç½®ç³»ç»Ÿ
2. **Hookæ‹†åˆ†** - GPS/MQTT ç¨³å®šæ€§éœ€è¦ç‹¬ç«‹é”™è¯¯å¤„ç†
3. **é”™è¯¯å¤„ç†æœºåˆ¶** - æµ·ä¸Šç¯å¢ƒå¿…éœ€

### 5. æ¸…ç†å†—ä½™æ–‡ä»¶

```bash
# åˆ é™¤ä¸å†éœ€è¦çš„æ–‡ä»¶
rm src/features/mqtt/hooks/useObserversPos.ts
rm src/features/mqtt/hooks/useObserverPosPublish.ts

# ç®€åŒ–å¤šè¯­è¨€æ–‡ä»¶
# ä¿ç•™åŸºæœ¬ç¿»è¯‘ï¼Œç§»é™¤å¤æ‚çš„æ’ä»¶i18nç³»ç»Ÿ
```

## åŠŸèƒ½æ‘˜è¦

### ä¿®å¤åŠŸèƒ½ âœ…
1. **åœ¨çº¿ç»Ÿè®¡å‡†ç¡®** - æ­£ç¡®æ˜¾ç¤ºæ‰€æœ‰ç”¨æˆ·ï¼ˆç®¡ç†å‘˜+è§‚å¯Ÿè€…+è‡ªå·±ï¼‰
2. **MQTTæ— é™é‡è¿** - æµ·ä¸Šä¿¡å·æ–­è¿ä¹Ÿèƒ½æ¢å¤
3. **GPSé«˜ç²¾åº¦è¿‡æ»¤** - æ‹’ç»>10ç±³ç²¾åº¦çš„æ•°æ®
4. **ç»Ÿä¸€çŠ¶æ€ç®¡ç†** - æ‰€æœ‰äººä½¿ç”¨ç›¸åŒçš„presenceæœºåˆ¶

### ä¿æŒåŠŸèƒ½ âœ…
1. **èˆªçº¿é…ç½®ç³»ç»Ÿ** - æ”¯æŒ10ç§èˆªçº¿ç±»å‹æ‰©å±•
2. **å®æ—¶ä½ç½®åŒæ­¥** - ç®¡ç†å‘˜å’Œè§‚å¯Ÿè€…ä½ç½®å®æ—¶æ›´æ–°
3. **ç½‘ç»œçŠ¶æ€ç›‘æ§** - æ˜¾ç¤ºè¿æ¥çŠ¶æ€å’Œä¿¡å·å¼ºåº¦
4. **ç¦»çº¿å®¹é”™** - ç½‘ç»œæ¢å¤åè‡ªåŠ¨é‡è¿

### ç®€åŒ–åŠŸèƒ½ âœ‚ï¸
1. **ç§»é™¤å¤æ‚å¤šè¯­è¨€** - æ”¹ä¸ºç®€å•å¯¹è±¡æ˜ å°„
2. **ç²¾ç®€UIç»„ä»¶** - ç§»é™¤ä¸»é¢˜åˆ‡æ¢ç­‰éæ ¸å¿ƒåŠŸèƒ½
3. **å‡å°‘Hookæ–‡ä»¶** - åˆå¹¶ç›¸å…³åŠŸèƒ½

## å®æ–½ä¼˜å…ˆçº§

### ğŸ”¥ ç«‹å³å®æ–½ï¼ˆç¨³å®šæ€§ä¿®å¤ï¼‰
1. MQTT æ— é™é‡è¿æœºåˆ¶
2. GPS ç²¾åº¦è¿‡æ»¤å’Œè¶…æ—¶ä¼˜åŒ–
3. ç»Ÿä¸€åœ¨çº¿çŠ¶æ€ç®¡ç†

### ğŸ› ï¸ åç»­å®æ–½ï¼ˆåŠŸèƒ½ä¼˜åŒ–ï¼‰
1. ç½‘ç»œçŠ¶æ€æŒ‡ç¤ºå™¨å¢å¼º
2. é”™è¯¯æç¤ºç”¨æˆ·å‹å¥½åŒ–
3. æ¶æ„ç®€åŒ–å’Œæ–‡ä»¶æ¸…ç†

## é¢„æœŸæ•ˆæœ

| æŒ‡æ ‡ | ä¿®å¤å‰ | ä¿®å¤å |
|------|--------|--------|
| åœ¨çº¿ç»Ÿè®¡å‡†ç¡®æ€§ | âŒ é”™è¯¯ | âœ… å‡†ç¡® |
| MQTTé‡è¿èƒ½åŠ› | 5æ¬¡åæ”¾å¼ƒ | æ— é™é‡è¿ |
| GPSæ•°æ®è´¨é‡ | æ¥å—ä»»ä½•ç²¾åº¦ | æ‹’ç»>10mç²¾åº¦ |
| ä»£ç å¤æ‚åº¦ | 41æ–‡ä»¶ | ~35æ–‡ä»¶ |
| ç»´æŠ¤éš¾åº¦ | å¤æ‚ | ç®€åŒ– |

è¿™ä¸ªæ–¹æ¡ˆç¡®ä¿åœ¨æ¶åŠ£çš„æµ·ä¸Šç¯å¢ƒä¸‹ç³»ç»Ÿä»èƒ½ç¨³å®šå·¥ä½œï¼ŒåŒæ—¶ç®€åŒ–äº†è¿‡åº¦è®¾è®¡çš„éƒ¨åˆ†ï¼Œæé«˜äº†ä»£ç çš„å¯ç»´æŠ¤æ€§ã€‚