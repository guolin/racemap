# 海上稳定性优化和架构简化方案

## 概述

针对海上信号不稳定环境，重新梳理系统架构，解决在线统计混乱问题，增强 MQTT/GPS 稳定性，同时简化非核心功能。

## 核心原则

1. **可靠性优先** - 海上环境不允许失败
2. **逻辑统一** - 避免管理员/观察者双重机制
3. **简化非核心** - 专注稳定性，移除过度设计

## 主要问题分析

### 🚨 在线统计逻辑混乱
- **管理员不在统计中** - 发布到不同主题 (`admin` vs `observer/*`)
- **自己不在统计中** - `useObserversPos` 跳过自己的消息
- **清理机制不一致** - 管理员5分钟TTL vs 观察者60秒清理
- **结果错误** - 1管理员+2观察者显示1人在线

### 🚨 MQTT 稳定性不足
- **重连限制过严** - 5次重连后永久放弃
- **重连间隔过短** - 2秒间隔消耗电量
- **海上场景不适配** - 信号可能断连很久

### 🚨 GPS 精度要求不严
- **无精度过滤** - 可能接受低精度数据
- **超时设置保守** - 10秒对海上GPS偏短

## 解决方案

### 1. 统一在线状态管理 🎯

#### 新的主题结构
```
旧: race/{raceId}/location/admin          (管理员)
旧: race/{raceId}/location/observer/{id}  (观察者)

新: race/{raceId}/presence/{userId}       (所有人统一)
```

#### 统一消息格式
```typescript
{
  id: "ADMIN" | "observer_xxx",
  role: "admin" | "observer",
  lat: number,
  lng: number,
  heading?: number,
  course?: { type: string, params: any }, // 仅管理员
  ts: number
}
```

#### 实施文件

**1. 修改管理员发布** - `src/features/mqtt/hooks/useMqttPosSync.ts`
```typescript
// 第18行，修改topic函数
const presenceTopic = (id: string) => `race/${id}/presence/ADMIN`;

// 第99行，修改发布逻辑
const payloadStr = JSON.stringify({
  id: 'ADMIN',
  role: 'admin',
  lat: pos.lat,
  lng: pos.lng,
  course: { type, params },
  ts: now
});
client.publish(presenceTopic(courseId), payloadStr, { retain: true, qos: 1 });
```

**2. 修改观察者发布** - `src/features/mqtt/service.ts`
```typescript
// 第92-111行，修改 publishObserverPos 函数
export function publishObserverPos(raceId: string, observerId: string, pos: ObserverPosition) {
  const c = getMqttClient();
  if (!c || !c.connected) return;

  const topic = `race/${raceId}/presence/${observerId}`;
  const payload = JSON.stringify({
    id: observerId,
    role: 'observer',
    lat: pos.lat,
    lng: pos.lng,
    heading: pos.heading,
    ts: Date.now()
  });

  c.publish(topic, payload, {
    qos: 0,
    retain: true,
    properties: { messageExpiryInterval: 60 } // 统一60秒过期
  });
}
```

**3. 新建统一的在线用户Hook** - `src/features/mqtt/hooks/useOnlineUsers.ts`
```typescript
import { useEffect, useState } from 'react';
import { useMqttClient } from '../hooks';

export interface OnlineUser {
  id: string;
  role: 'admin' | 'observer';
  lat: number;
  lng: number;
  heading?: number;
  course?: { type: string; params: any };
  ts: number;
}

export function useOnlineUsers(raceId: string, currentUserId: string) {
  const client = useMqttClient();
  const [users, setUsers] = useState<Record<string, OnlineUser>>({});

  useEffect(() => {
    if (!client) return;

    const topicFilter = `race/${raceId}/presence/+`;

    const onMsg = (topic: string, payload: Uint8Array) => {
      try {
        const userId = topic.split('/').pop()!;
        const data = JSON.parse(new TextDecoder().decode(payload));

        setUsers(prev => {
          const now = Date.now();
          // 统一60秒过期清理
          const cleaned: Record<string, OnlineUser> = {};
          Object.entries(prev).forEach(([id, user]) => {
            if (now - user.ts < 60_000) {
              cleaned[id] = user;
            }
          });

          // 添加/更新用户（包括自己）
          cleaned[userId] = {
            id: data.id,
            role: data.role,
            lat: data.lat,
            lng: data.lng,
            heading: data.heading,
            course: data.course,
            ts: data.ts
          };

          return cleaned;
        });
      } catch (e) {
        console.error('[useOnlineUsers] Parse error:', e);
      }
    };

    client.subscribe(topicFilter, { qos: 0 });
    client.on('message', onMsg);

    return () => {
      client.unsubscribe(topicFilter);
      client.off('message', onMsg);
    };
  }, [client, raceId]);

  const allUsers = Object.values(users);
  return {
    allUsers,
    onlineCount: allUsers.length,
    otherUsers: allUsers.filter(u => u.id !== currentUserId),
    admin: allUsers.find(u => u.role === 'admin'),
    observers: allUsers.filter(u => u.role === 'observer')
  };
}
```

**4. 更新 RaceMap 组件** - `src/features/map/RaceMap.tsx`
```typescript
// 第263-270行，替换现有逻辑
import { useOnlineUsers } from '@features/mqtt/hooks/useOnlineUsers';

// 替换 useObserversPos 为新的统一hook
const { allUsers, onlineCount, otherUsers, admin } = useOnlineUsers(
  courseId, 
  isAdmin ? 'ADMIN' : observerIdRef.current
);

// 第295行，保持现有显示逻辑
right={<OnlineCount count={onlineCount} />}

// 第305行，更新观察者列表
<ObserversList observers={otherUsers} currentObserverId={isAdmin ? 'ADMIN' : observerIdRef.current} />
```

### 2. 强化 MQTT 稳定性 🔧

**文件**: `src/features/mqtt/service.ts`

```typescript
// 第29-38行，优化连接参数
const options: IClientOptions = {
  reconnectPeriod: 8000,   // 8秒重连间隔，避免频繁重连
  connectTimeout: 15000,   // 15秒连接超时
  keepalive: 30,           // 30秒心跳，节省流量
  clean: true,
  clientId: `rc_${Math.random().toString(16).slice(2, 10)}`,
  username: process.env.NEXT_PUBLIC_MQTT_USERNAME,
  password: process.env.NEXT_PUBLIC_MQTT_PASSWORD,
  protocolVersion: 5,
};

// 第47-53行，移除重连限制
c.on('reconnect', () => {
  console.warn('[MQTT] reconnecting… count:', ++reconnectCount);
  // ❌ 删除这段代码，允许无限重连
  // if (reconnectCount > 5) {
  //   console.error('[MQTT] too many reconnection attempts, closing connection');
  //   c.end(true);
  //   client = null;
  // }
});
```

### 3. 强化 GPS 精度控制 🎯

**文件**: `src/features/map/hooks/useGpsWatch.ts`

```typescript
// 第75-79行，优化GPS配置
watchIdRef.current = navigator.geolocation.watchPosition(handler, errorHandler, {
  enableHighAccuracy: true,
  maximumAge: 0,          // 不允许缓存，确保数据新鲜
  timeout: 20000,         // 20秒超时，给海上GPS更多时间
});

// 第40行后，添加精度过滤
const handler = (pos: GeolocationPosition) => {
  const { latitude, longitude, heading, speed, accuracy } = pos.coords as GeolocationCoordinates & { heading: number };
  
  // 严格精度要求：拒绝低精度数据
  if (accuracy && accuracy > 10) {
    console.debug('[GPS] Position rejected: accuracy', accuracy, 'm');
    return; // 没有数据好过错误数据
  }
  
  // 合理性检查：防止GPS跳点
  if (lastLatLngRef.current) {
    const distance = lastLatLngRef.current.distanceTo(L.latLng(latitude, longitude));
    if (distance > 500) { // 500米跳跃检测
      console.debug('[GPS] Position rejected: unrealistic jump', distance, 'm');
      return;
    }
  }

  const latlng = L.latLng(latitude, longitude);
  // ... 其余逻辑保持不变
};

// 第71-73行，优化错误处理
const errorHandler = (err: GeolocationPositionError) => {
  let errorMessage = '';
  switch (err.code) {
    case 1: errorMessage = 'GPS权限被拒绝，请在设置中允许位置访问'; break;
    case 2: errorMessage = 'GPS信号弱，请移动到开阔位置'; break;
    case 3: errorMessage = 'GPS定位超时，请检查GPS设置'; break;
    default: errorMessage = `GPS错误: ${err.message}`;
  }
  setState((s) => ({ ...s, ok: false, errorMsg: errorMessage }));
};
```

### 4. 架构简化 ✂️

#### 删除过度设计
1. **多语言系统简化** - 删除 `CoursePluginI18n`，改为简单对象映射
2. **UI库精简** - 移除 `next-themes`，保留核心 shadcn/ui 组件
3. **Hook整合** - 合并相关功能，减少文件数量

#### 保留必要设计
1. **航线插件系统** - 10个航线类型需要配置系统
2. **Hook拆分** - GPS/MQTT 稳定性需要独立错误处理
3. **错误处理机制** - 海上环境必需

### 5. 清理冗余文件

```bash
# 删除不再需要的文件
rm src/features/mqtt/hooks/useObserversPos.ts
rm src/features/mqtt/hooks/useObserverPosPublish.ts

# 简化多语言文件
# 保留基本翻译，移除复杂的插件i18n系统
```

## 功能摘要

### 修复功能 ✅
1. **在线统计准确** - 正确显示所有用户（管理员+观察者+自己）
2. **MQTT无限重连** - 海上信号断连也能恢复
3. **GPS高精度过滤** - 拒绝>10米精度的数据
4. **统一状态管理** - 所有人使用相同的presence机制

### 保持功能 ✅
1. **航线配置系统** - 支持10种航线类型扩展
2. **实时位置同步** - 管理员和观察者位置实时更新
3. **网络状态监控** - 显示连接状态和信号强度
4. **离线容错** - 网络恢复后自动重连

### 简化功能 ✂️
1. **移除复杂多语言** - 改为简单对象映射
2. **精简UI组件** - 移除主题切换等非核心功能
3. **减少Hook文件** - 合并相关功能

## 实施优先级

基于代码审查反馈，采用**分阶段渐进式实施**策略，确保系统稳定性：

### 🧪 阶段1：方案验证（低风险，1-2天）
**目标**：验证新逻辑正确性，不影响现有功能

1. **创建新的统一Hook** - `src/features/mqtt/hooks/useOnlineUsers.ts`
   - 订阅新旧两套主题格式（兼容性处理）
   - 在 RaceMap 中并行运行新旧逻辑
   - 通过控制台日志对比统计结果

2. **验证统计准确性**
   - 测试场景：1管理员 + 2观察者
   - 预期结果：新逻辑显示3人，旧逻辑显示1人
   - 确保新逻辑包含管理员和自己

### 🔄 阶段2：逐步切换（中风险，3-5天）
**目标**：逐个替换发布和统计逻辑

1. **切换在线统计逻辑**
   - RaceMap.tsx 第262-270行：替换 `useObserversPos` 为 `useOnlineUsers`
   - 保留观察者列表显示功能
   - 验证在线计数准确性

2. **修改管理员发布逻辑**
   - useMqttPosSync.ts 第18行：修改 topic 函数
   - useMqttPosSync.ts 第99行：修改 payload 格式，添加 role 字段
   - 确保管理员出现在在线列表中

3. **修改观察者发布逻辑**
   - service.ts 第100行：修改观察者 topic
   - 统一消息格式和过期时间（60秒）
   - 验证观察者正常显示

### ⚡ 阶段3：稳定性优化（低风险，2-3天）
**目标**：增强海上环境稳定性

1. **MQTT 无限重连**
   - service.ts 第47-53行：移除5次重连限制
   - 调整重连参数（8秒间隔，15秒超时）

2. **GPS 精度控制**
   - useGpsWatch.ts：添加10米精度过滤
   - 添加500米跳跃检测
   - 优化超时和错误处理

3. **清理旧代码**
   - 删除 `useObserversPos.ts` 和 `useObserverPosPublish.ts`
   - 移除兼容性代码
   - 简化架构

### 🔍 阶段4：架构简化（低风险，按需进行）
1. 简化多语言系统
2. 精简UI组件
3. 合并相关Hook文件

## 实施风险控制

### 🛡️ 兼容性处理
新的 `useOnlineUsers` Hook 需要同时支持新旧主题格式：
```typescript
// 兼容旧格式
`race/${raceId}/location/admin`          // 管理员
`race/${raceId}/location/observer/*`     // 观察者

// 支持新格式  
`race/${raceId}/presence/*`              // 统一格式
```

### 🧪 测试验证策略
1. **并行运行**：新旧逻辑同时运行，对比结果
2. **日志监控**：详细记录统计差异和异常情况
3. **回滚机制**：出现问题可快速回退到原有逻辑

### 📋 关键验证点
| 测试场景 | 旧逻辑显示 | 新逻辑预期 | 验证重点 |
|----------|------------|------------|----------|
| 1管理员 | 0人 | 1人 | 管理员统计 |
| 1管理员+2观察者 | 1人 | 3人 | 完整统计 |
| 3观察者 | 2人 | 3人 | 自己统计 |
| 用户离线 | 延迟清理 | 60秒统一清理 | 清理机制 |

## 预期效果

| 指标 | 修复前 | 修复后 | 实施阶段 |
|------|--------|--------|----------|
| 在线统计准确性 | ❌ 错误 | ✅ 准确 | 阶段1-2 |
| MQTT重连能力 | 5次后放弃 | 无限重连 | 阶段3 |
| GPS数据质量 | 接受任何精度 | 拒绝>10m精度 | 阶段3 |
| 代码复杂度 | 41文件 | ~35文件 | 阶段4 |
| 维护难度 | 复杂 | 简化 | 全阶段 |
| 实施风险 | - | 低风险渐进 | 分阶段控制 |

## 成功标准

### 阶段1成功标准
- [ ] 新逻辑正确统计所有用户（包括管理员和自己）
- [ ] 兼容性处理无异常
- [ ] 控制台日志显示统计差异

### 阶段2成功标准  
- [ ] 在线计数准确显示
- [ ] 管理员出现在在线列表
- [ ] 观察者列表正常工作
- [ ] 无功能回退

### 阶段3成功标准
- [ ] MQTT 连接在信号差环境下能持续重连
- [ ] GPS 只接受高精度位置数据（≤10m）
- [ ] 系统在海上环境稳定运行

这个**分阶段渐进式方案**确保在优化系统的同时最大程度降低风险，特别适合海上关键应用场景。