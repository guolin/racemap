# Feature 001: æ ¸å¿ƒæ€§èƒ½å’Œç¨³å®šæ€§ä¼˜åŒ–

> **åˆ›å»ºæ—¶é—´**: 2025-01-12  
> **ä¼˜å…ˆçº§**: P0 (é«˜)  
> **ä¼°æ—¶**: 2-3å¤©  
> **çŠ¶æ€**: å¾…å®æ–½

## ğŸ“‹ æ‘˜è¦

åŸºäºä»£ç åˆ†æï¼Œé’ˆå¯¹å¸†èˆ¹è£åˆ¤å®æ—¶å®šä½ç³»ç»Ÿçš„å®é™…ä½¿ç”¨åœºæ™¯ï¼ˆ3-10äººå°å›¢é˜Ÿï¼Œé«˜ç²¾åº¦è¦æ±‚ï¼Œç½‘ç»œçŠ¶æ€ä¼˜å…ˆï¼‰è¿›è¡Œæ ¸å¿ƒä¼˜åŒ–ã€‚ä¸»è¦è§£å†³å‚æ•°å˜åŒ–å¼•èµ·çš„é¢‘ç¹é‡æ¸²æŸ“é—®é¢˜ï¼Œæå‡GPSç²¾åº¦ï¼Œå¢å¼ºç½‘ç»œçŠ¶æ€æ˜¾ç¤ºã€‚

### æ ¸å¿ƒé—®é¢˜
- `RaceMap.tsx` ä¸­ `params` å¯¹è±¡å¼•ç”¨å˜åŒ–å¯¼è‡´MQTTé¢‘ç¹å‘å¸ƒ
- GPSä½ç½®ç²¾åº¦é˜ˆå€¼è¿‡å¤§ï¼ˆ1ç±³ï¼‰ï¼Œä¸æ»¡è¶³å¸†èˆ¹æ¯”èµ›éœ€æ±‚
- ç½‘ç»œçŠ¶æ€æ˜¾ç¤ºä¸å¤Ÿçªå‡ºï¼Œæ–­ç½‘æ—¶ç”¨æˆ·æ„ŸçŸ¥ä¸æ˜æ˜¾
- è§‚å¯Ÿè€…åˆ—è¡¨æ˜¾ç¤ºå¯ä¼˜åŒ–ï¼Œæ›´é€‚åˆå°å›¢é˜Ÿåä½œ

## ğŸ”§ æ”¹åŠ¨æ–‡ä»¶

### 1. æ ¸å¿ƒä¿®å¤æ–‡ä»¶
- `src/features/map/RaceMap.tsx` - ä¿®å¤paramså¼•ç”¨é—®é¢˜
- `src/features/mqtt/hooks/useMqttPosSync.ts` - è°ƒæ•´ä½ç½®ç²¾åº¦é˜ˆå€¼
- `src/features/map/components/TopBar.tsx` - å¢å¼ºç½‘ç»œçŠ¶æ€æ˜¾ç¤º

### 2. æ–°å¢æ–‡ä»¶
- `src/features/network/hooks/useNetworkStatus.ts` - ç½‘ç»œçŠ¶æ€ç®¡ç†Hook
- `src/features/map/components/NetworkIndicator.tsx` - ç½‘ç»œçŠ¶æ€æŒ‡ç¤ºå™¨
- `src/features/map/components/ObserversList.tsx` - ä¼˜åŒ–çš„è§‚å¯Ÿè€…åˆ—è¡¨

### 3. é…ç½®è°ƒæ•´
- `context/GpsContext.tsx` - GPSé…ç½®ä¼˜åŒ–

## ğŸ¯ å…·ä½“æ”¹åŠ¨å†…å®¹

### 1. ä¿®å¤é¢‘ç¹é‡æ¸²æŸ“é—®é¢˜

**æ–‡ä»¶**: `src/features/map/RaceMap.tsx`

```typescript
// é—®é¢˜ä»£ç  (ç¬¬235-239è¡Œ)
useEffect(() => {
  if (isAdmin && publishNow) publishNow();
}, [isAdmin, type, params]); // paramså¯¹è±¡å¼•ç”¨é¢‘ç¹å˜åŒ–

// ä¿®å¤å - ä½¿ç”¨ç¨³å®šçš„å‚æ•°åºåˆ—åŒ–
const paramsHash = useMemo(() => {
  // ç¨³å®šåºåˆ—åŒ–ï¼Œé¿å…keyé¡ºåºé—®é¢˜
  const keys = Object.keys(params).sort();
  const stable = keys.reduce((acc, key) => {
    acc[key] = params[key];
    return acc;
  }, {} as typeof params);
  return JSON.stringify(stable);
}, [params]);

useEffect(() => {
  if (isAdmin && publishNow) publishNow();
}, [isAdmin, type, paramsHash]); // ä½¿ç”¨ç¨³å®šhashé¿å…å¼•ç”¨æ¯”è¾ƒ
```

### 2. æå‡GPSä½ç½®ç²¾åº¦å’Œå‘å¸ƒæ§åˆ¶

**æ–‡ä»¶**: `src/features/mqtt/hooks/useMqttPosSync.ts`

```typescript
// å½“å‰é˜ˆå€¼ (ç¬¬52è¡Œ)
const POSITION_THRESHOLD = 0.00001; // çº¦1ç±³

// ä¼˜åŒ–ä¸ºæ›´é«˜ç²¾åº¦ï¼Œå¹¶å¢åŠ å‘å¸ƒé—´éš”æ§åˆ¶
const POSITION_THRESHOLD = 0.000005; // çº¦0.5ç±³ï¼Œæ»¡è¶³å¸†èˆ¹æ¯”èµ›ç²¾åº¦éœ€æ±‚
const MIN_PUBLISH_INTERVAL = 2000; // æœ€å°‘2ç§’é—´éš”ï¼Œé¿å…GPSæŠ–åŠ¨

// å¢åŠ æ—¶é—´æˆ³å¼•ç”¨
const lastPublishTimeRef = useRef<number>(0);

const tryPublish = () => {
  if (!client.connected) {
    console.debug('[MQTT] Skip publishing, client not connected');
    return;
  }
  
  const pos = getLatestPosRef.current();
  if (!pos) {
    console.debug('[MQTT] Skip publishing, no position available');
    return;
  }
  
  // æ£€æŸ¥æœ€å°å‘å¸ƒé—´éš”
  const now = Date.now();
  if (now - lastPublishTimeRef.current < MIN_PUBLISH_INTERVAL) {
    console.debug('[MQTT] Skip publishing, within minimum interval');
    return;
  }
  
  // ... ç°æœ‰å‘å¸ƒé€»è¾‘ä¿æŒä¸å˜
  
  try {
    const { type, params } = getCourseDataRef.current();
    const payloadStr = JSON.stringify({ 
      id: 'ADMIN',
      lat: pos.lat,
      lng: pos.lng,
      course: { type, params },
      timestamp: now
    });
    
    client.publish(posTopic(courseId), payloadStr, { retain: true, qos: 1 }, (err) => {
      if (err) {
        console.error('[MQTT] Failed to publish:', err);
        return;
      }
      console.debug('[MQTT] Published position update');
      lastPublishTimeRef.current = now; // è®°å½•æˆåŠŸå‘å¸ƒæ—¶é—´
      lastPayloadRef.current = JSON.stringify({
        lat: pos.lat,
        lng: pos.lng,
        course: { type, params }
      });
    });
  } catch (e) {
    console.error('[MQTT] Error preparing payload:', e);
  }
};
```

### 3. æ–°å¢ç½‘ç»œçŠ¶æ€ç®¡ç†Hook

**æ–‡ä»¶**: `src/features/network/hooks/useNetworkStatus.ts`

```typescript
export interface NetworkStatus {
  status: 'online' | 'offline' | 'mqtt_error' | 'stale';
  message: string;
  isHealthy: boolean;
}

export function useNetworkStatus(mqttClient?: MqttClient): NetworkStatus {
  const [isOnline, setIsOnline] = useState(navigator.onLine);
  const [mqttConnected, setMqttConnected] = useState(false);
  const [lastSyncTime, setLastSyncTime] = useState<number | null>(null);
  
  // ç›‘å¬ç½‘ç»œçŠ¶æ€
  useEffect(() => {
    const handleOnline = () => setIsOnline(true);
    const handleOffline = () => setIsOnline(false);
    
    window.addEventListener('online', handleOnline);
    window.addEventListener('offline', handleOffline);
    
    return () => {
      window.removeEventListener('online', handleOnline);
      window.removeEventListener('offline', handleOffline);
    };
  }, []);
  
  // ç›‘å¬MQTTè¿æ¥çŠ¶æ€ - ä¿®æ­£äº‹ä»¶å
  useEffect(() => {
    if (!mqttClient) return;
    
    const handleConnect = () => {
      setMqttConnected(true);
      setLastSyncTime(Date.now());
    };
    const handleOffline = () => setMqttConnected(false);
    const handleMessage = () => setLastSyncTime(Date.now());
    
    mqttClient.on('connect', handleConnect);
    mqttClient.on('reconnect', handleConnect);  
    mqttClient.on('offline', handleOffline);
    mqttClient.on('close', handleOffline);
    mqttClient.on('error', handleOffline);
    mqttClient.on('message', handleMessage); // æ›´æ–°åŒæ­¥æ—¶é—´
    
    return () => {
      mqttClient.off('connect', handleConnect);
      mqttClient.off('reconnect', handleConnect);
      mqttClient.off('offline', handleOffline);
      mqttClient.off('close', handleOffline);
      mqttClient.off('error', handleOffline);
      mqttClient.off('message', handleMessage);
    };
  }, [mqttClient]);
  
  return useMemo(() => {
    if (!isOnline) return { 
      status: 'offline', 
      message: 'ç½‘ç»œå·²æ–­å¼€', 
      isHealthy: false 
    };
    
    if (!mqttConnected) return { 
      status: 'mqtt_error', 
      message: 'MQTTè¿æ¥ä¸­...', 
      isHealthy: false 
    };
    
    if (lastSyncTime && Date.now() - lastSyncTime > 30000) {
      return { 
        status: 'stale', 
        message: 'æ•°æ®å¯èƒ½è¿‡æœŸ', 
        isHealthy: false 
      };
    }
    
    return { 
      status: 'online', 
      message: 'å®æ—¶åŒæ­¥ä¸­', 
      isHealthy: true 
    };
  }, [isOnline, mqttConnected, lastSyncTime]);
}
```

### 4. ç½‘ç»œçŠ¶æ€æŒ‡ç¤ºå™¨ç»„ä»¶

**æ–‡ä»¶**: `src/features/map/components/NetworkIndicator.tsx`

```typescript
interface NetworkIndicatorProps {
  status: NetworkStatus;
  className?: string;
}

export const NetworkIndicator: React.FC<NetworkIndicatorProps> = ({ 
  status, 
  className = '' 
}) => {
  const statusConfig = {
    online: { 
      color: 'bg-green-500', 
      icon: 'ğŸŸ¢',
      priority: 'low' 
    },
    offline: { 
      color: 'bg-red-500 animate-pulse', 
      icon: 'ğŸ”´',
      priority: 'critical' 
    },
    mqtt_error: { 
      color: 'bg-yellow-500 animate-pulse', 
      icon: 'ğŸŸ¡',
      priority: 'high' 
    },
    stale: { 
      color: 'bg-orange-500', 
      icon: 'ğŸŸ ',
      priority: 'medium' 
    }
  };
  
  const config = statusConfig[status.status];
  
  return (
    <div className={`
      flex items-center gap-1 px-2 py-1 rounded text-xs font-bold text-white
      ${config.color} ${className}
      ${config.priority === 'critical' ? 'ring-2 ring-red-300' : ''}
    `}>
      <span>{config.icon}</span>
      <span>{status.message}</span>
    </div>
  );
};
```

### 5. ä¼˜åŒ–è§‚å¯Ÿè€…åˆ—è¡¨æ˜¾ç¤º

**æ–‡ä»¶**: `src/features/map/components/ObserversList.tsx`

```typescript
interface ObserversListProps {
  observers: ObserverPos[];
  currentObserverId: string;
}

export const ObserversList: React.FC<ObserversListProps> = ({ 
  observers, 
  currentObserverId 
}) => {
  const sortedObservers = useMemo(() => 
    observers
      .filter(obs => obs.id !== currentObserverId) // æ’é™¤è‡ªå·±
      .sort((a, b) => b.ts - a.ts) // æŒ‰æœ€æ–°æ—¶é—´æ’åºï¼Œä½¿ç”¨å®é™…å­—æ®µå
  , [observers, currentObserverId]);

  return (
    <div className="absolute top-20 right-4 bg-black/80 text-white rounded-lg p-3 text-xs min-w-[180px]">
      <div className="font-bold mb-2 flex items-center gap-2">
        <span>åœ¨çº¿è£åˆ¤</span>
        <span className="bg-blue-500 px-1.5 py-0.5 rounded">
          {sortedObservers.length + 1}
        </span>
      </div>
      
      {/* è‡ªå·±çš„çŠ¶æ€ */}
      <div className="flex items-center gap-2 mb-2 p-1 bg-blue-500/20 rounded">
        <div className="w-2 h-2 rounded-full bg-blue-400" />
        <span className="font-medium">{currentObserverId} (æˆ‘)</span>
      </div>
      
      {/* å…¶ä»–è§‚å¯Ÿè€… */}
      {sortedObservers.map(obs => {
        const timeDiff = Date.now() - obs.ts; // ä½¿ç”¨å®é™…å­—æ®µå ts
        const isRecent = timeDiff < 10000; // 10ç§’å†…
        const secondsAgo = Math.round(timeDiff / 1000);
        
        return (
          <div key={obs.id} className="flex items-center gap-2 mb-1 p-1 rounded hover:bg-white/10">
            <div className={`w-2 h-2 rounded-full ${
              isRecent ? 'bg-green-400' : 'bg-yellow-400'
            }`} />
            <span className="flex-1">{obs.id}</span>
            <span className={`text-xs ${
              isRecent ? 'text-green-300' : 'text-yellow-300'
            }`}>
              {secondsAgo}så‰
            </span>
          </div>
        );
      })}
      
      {sortedObservers.length === 0 && (
        <div className="text-gray-400 text-center py-2">
          æš‚æ— å…¶ä»–è£åˆ¤åœ¨çº¿
        </div>
      )}
    </div>
  );
};
```

### 6. GPSé…ç½®ä¼˜åŒ–

**æ–‡ä»¶**: `context/GpsContext.tsx`

```typescript
// å½“å‰GpsContexté…ç½® (ç¬¬72è¡Œ)
navigator.geolocation.getCurrentPosition(handleSuccess, handleError, { 
  enableHighAccuracy: true, 
  maximumAge: 0, 
  timeout: 2000  // å½“å‰2ç§’è¶…æ—¶
});

// å»ºè®®ä¼˜åŒ–ä¸ºä¸useGpsWatchå¯¹é½ï¼Œæé«˜è¶…æ—¶æ—¶é—´ç¡®ä¿é«˜ç²¾åº¦
navigator.geolocation.getCurrentPosition(handleSuccess, handleError, { 
  enableHighAccuracy: true, 
  maximumAge: 0,        // ä¿æŒä¸ä½¿ç”¨ç¼“å­˜
  timeout: 5000         // æå‡åˆ°5ç§’æˆ–ä¸useGpsWatchçš„10ç§’å¯¹é½
});

// watchPositioné…ç½®åŒæ­¥è°ƒæ•´ (ç¬¬86-91è¡Œ)
watchIdRef.current = watchPositionThrottled(handleSuccess, handleError, {
  enableHighAccuracy: true,
  maximumAge: 0,
  timeout: 5000,        // ä»2000msæå‡åˆ°5000ms
  throttleTime: throttleMs,
});
```

**æ³¨æ„**: ä¸»è¦ç»„ä»¶ä½¿ç”¨çš„æ˜¯`useGpsWatch` (å·²æœ‰10ç§’è¶…æ—¶)ï¼Œæ­¤è°ƒæ•´ä¸»è¦å½±å“ä»åœ¨ä½¿ç”¨`GpsContext`çš„åœºæ™¯ã€‚

### 7. åœ¨RaceMapä¸­é›†æˆç½‘ç»œçŠ¶æ€

**æ–‡ä»¶**: `src/features/map/RaceMap.tsx`

```typescript
// TopBarå½“å‰æ˜¯æ’æ§½å¼ç»“æ„ï¼Œä¸éœ€è¦ä¿®æ”¹TopBaræœ¬èº«
// åœ¨RaceMapä¸­æ·»åŠ ç½‘ç»œçŠ¶æ€åˆ°TopBarçš„leftæ’æ§½

export default function RaceMap({ courseId, isAdmin = false }: Props) {
  const client = useMqttClient(); // å¯¼å…¥ç°æœ‰çš„å®¢æˆ·ç«¯hook
  const networkStatus = useNetworkStatus(client);
  
  // ... ç°æœ‰é€»è¾‘ä¿æŒä¸å˜
  
  return (
    <div 
      className="relative w-screen" 
      style={{ height: viewportHeight > 0 ? viewportHeight : '100vh' }}
    >
      <div id="map-root" className="w-full h-full" />
      
      <TopBar 
        left={<NetworkIndicator status={networkStatus} />} // æ–°å¢ç½‘ç»œçŠ¶æ€åˆ°leftæ’æ§½
        center={centerContent} 
        right={<OnlineCount count={onlineCount} />} 
      />
      
      {/* æ–°å¢è§‚å¯Ÿè€…åˆ—è¡¨ */}
      {!isAdmin && (
        <ObserversList 
          observers={observers} 
          currentObserverId={observerIdRef.current} 
        />
      )}
      
      {/* ... å…¶ä½™UIä¿æŒä¸å˜ */}
    </div>
  );
}
```

**æ³¨æ„**: TopBarç»„ä»¶æ”¯æŒ`left`ã€`center`ã€`right`ä¸‰ä¸ªæ’æ§½ï¼Œç½‘ç»œçŠ¶æ€é€‚åˆæ”¾åœ¨`left`ä½ç½®ã€‚

## âœ… éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½éªŒæ”¶
1. [ ] ä¿®å¤åä¸å†å› è¯¾ç¨‹å‚æ•°å¾®è°ƒé¢‘ç¹è§¦å‘MQTTå‘å¸ƒ
2. [ ] GPSä½ç½®åŒæ­¥ç²¾åº¦æå‡åˆ°0.5ç±³çº§åˆ«
3. [ ] ç½‘ç»œæ–­å¼€æ—¶æœ‰æ˜æ˜¾çš„è§†è§‰æç¤º
4. [ ] è§‚å¯Ÿè€…åˆ—è¡¨æ¸…æ™°æ˜¾ç¤ºåœ¨çº¿çŠ¶æ€å’Œæœ€ååŒæ­¥æ—¶é—´

### æ€§èƒ½éªŒæ”¶
1. [ ] RaceMapç»„ä»¶é‡æ¸²æŸ“é¢‘ç‡æ˜¾è‘—é™ä½
2. [ ] MQTTæ¶ˆæ¯å‘å¸ƒé¢‘ç‡æ§åˆ¶åœ¨2ç§’æœ€å°é—´éš”
3. [ ] ç½‘ç»œçŠ¶æ€æ£€æŸ¥ä¸å½±å“ä¸»è¦åŠŸèƒ½æ€§èƒ½

### ç”¨æˆ·ä½“éªŒéªŒæ”¶
1. [ ] ç½‘ç»œé—®é¢˜èƒ½ç¬¬ä¸€æ—¶é—´è¢«ç”¨æˆ·å¯Ÿè§‰
2. [ ] è§‚å¯Ÿè€…åˆ—è¡¨ä¿¡æ¯ä¸€ç›®äº†ç„¶ï¼Œé€‚åˆå°å›¢é˜Ÿä½¿ç”¨
3. [ ] GPSç²¾åº¦æ»¡è¶³å¸†èˆ¹æ¯”èµ›ä¸“ä¸šéœ€æ±‚

## ğŸš€ å®æ–½è®¡åˆ’

### Day 1
- ä¿®å¤RaceMap.tsxçš„paramså¼•ç”¨é—®é¢˜
- å®ç°useNetworkStatus Hook
- è°ƒæ•´GPSé…ç½®å’Œä½ç½®ç²¾åº¦é˜ˆå€¼

### Day 2  
- å®ç°NetworkIndicatorç»„ä»¶
- å®ç°ObserversListç»„ä»¶
- é›†æˆåˆ°TopBarå’ŒRaceMap

### Day 3
- å…¨é¢æµ‹è¯•å’Œè°ƒä¼˜
- éªŒæ”¶æ ‡å‡†æ£€æŸ¥
- æ–‡æ¡£æ›´æ–°

## ğŸ“ æ³¨æ„äº‹é¡¹å’Œä»£ç å®¡æŸ¥åé¦ˆ

### åŸºäºå®é™…ä»£ç å®¡æŸ¥çš„ä¿®æ­£ç‚¹

1. **MQTTäº‹ä»¶åä¿®æ­£**: ä½¿ç”¨æ­£ç¡®çš„mqtt.jsäº‹ä»¶å (`connect`, `reconnect`, `offline`, `close`, `error`)ï¼Œé¿å…ä¸å­˜åœ¨çš„ `disconnect` äº‹ä»¶
2. **è§‚å¯Ÿè€…æ•°æ®å­—æ®µ**: ä½¿ç”¨å®é™…çš„å­—æ®µå `obs.ts` è€Œä¸æ˜¯ `obs.timestamp`
3. **TopBaræ’æ§½ç»“æ„**: åˆ©ç”¨ç°æœ‰çš„ `left`ã€`center`ã€`right` æ’æ§½ï¼Œæ— éœ€ä¿®æ”¹TopBarç»„ä»¶æœ¬èº«
4. **GPSé…ç½®å½±å“èŒƒå›´**: ä¸»è¦å½±å“ä»ä½¿ç”¨GpsContextçš„åœºæ™¯ï¼Œæ ¸å¿ƒåŠŸèƒ½ä½¿ç”¨useGpsWatchå·²æœ‰è¾ƒå¥½é…ç½®
5. **å‚æ•°åºåˆ—åŒ–ç¨³å®šæ€§**: ä½¿ç”¨é”®æ’åºç¡®ä¿JSONåºåˆ—åŒ–çš„ç¨³å®šæ€§ï¼Œé¿å…keyé¡ºåºå¯¼è‡´çš„è¯¯è§¦å‘

### å®æ–½ç»†èŠ‚

1. **ä¿æŒæ¶æ„ç®€å•**: ä¸å¼•å…¥å¤æ‚çš„çŠ¶æ€ç®¡ç†ï¼Œç»´æŒç°æœ‰çš„Hookæ¨¡å¼
2. **å‘åå…¼å®¹**: æ‰€æœ‰æ”¹åŠ¨ä¿æŒä¸ç°æœ‰åŠŸèƒ½çš„å…¼å®¹æ€§  
3. **æµ‹è¯•é‡ç‚¹**: é‡ç‚¹æµ‹è¯•ç½‘ç»œä¸ç¨³å®šæƒ…å†µä¸‹çš„è¡¨ç°ï¼ŒéªŒè¯å‚æ•°å˜åŒ–æ—¶çš„å‘å¸ƒé¢‘ç‡
4. **ç§»åŠ¨ç«¯é€‚é…**: ç¡®ä¿æ–°å¢UIåœ¨æ‰‹æœºå±å¹•ä¸Šæ­£å¸¸æ˜¾ç¤º
5. **æ€§èƒ½ç›‘æ§**: å…³æ³¨JSON.stringifyçš„æ€§èƒ½å¼€é”€ï¼Œå¿…è¦æ—¶è€ƒè™‘æµ…å±‚æ¯”è¾ƒä¼˜åŒ–

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [é¡¹ç›®æ¶æ„æ–‡æ¡£](../æ¶æ„ä¸ä¸šåŠ¡é€»è¾‘.md)
- [MQTTé€šä¿¡åè®®](../README.md#æ ¸å¿ƒåŠŸèƒ½)
- [GPSç²¾åº¦è¦æ±‚è¯´æ˜](../éœ€æ±‚æ–‡æ¡£.md)