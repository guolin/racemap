# 003 - 世界帆联 IO 航线（Inner Outer Trapezoid Course）

## 概述

IO 航线是指世界帆联（World Sailing）认可的梯形内外圈航线（Inner Outer Trapezoid Course），这是一种专为同时容纳两个不同级别或两个相同级别船队而设计的高效赛道布局。

## 航线特点

### 基本结构
- **I** = 内圈梯形（Inner trapezoid）
- **O** = 外圈梯形（Outer trapezoid）
- 两条平行的迎风-顺风航线
- 共用相同的起航线和终点线
- 通过到达段分隔内外圈

### 标记系统
梯形航线包含多个标记：
- **标记1**：位于标记4的正迎风方向
- **标记2**：使用从2到1和从2到4的方位角定位
- **标记3**：位于标记2的正顺风方向，并使用回到标记4的方位角
- **标记4**：作为整个航线的参考点

### 几何要求
- 到达段（标记1到标记2）长度应约为迎风段长度的2/3
- 到达段角度通常设为60度
- 内外圈的迎风段必须平行且等长

## 航线信号系统

世界帆联使用字母和数字组合的系统为航线分配信号：
- 字母表示航线类型（I/O）
- 数字表示参赛者完成该航线需要航行的迎风段数量

### 常见航线序列
- **O2**: 起航 - 1 - 2 - 3s/3p - 2 - 3p - 终点
- **O3**: 起航 - 1 - 2 - 3s/3p - 2 - 3s/3p - 2 - 3p - 终点  
- **O4**: 起航 - 1 - 2 - 3s/3p - 2 - 3s/3p - 2 - 3s/3p - 2 - 3p - 终点

## 应用场景

### 比赛优势
1. **空间效率**：在有限水域内同时进行多个级别比赛
2. **分流效果**：有效分离不同速度的船队
3. **观赏性**：提供丰富的战术选择和超越机会

### 适用赛事
- 奖牌赛（Medal Race）
- 大型多级别帆船赛事
- 混合船队比赛
- 需要同时进行多场比赛的锦标赛

## 技术挑战

### 设置难度
1. **风向变化**：比三角形或香肠形航线更难调整
2. **标记重新定位**：风向改变时需要使用修正方位角重新定位标记1、2、3
3. **精确计算**：需要准确的方位角和距离计算

### 运营要求
- 专业的赛事组织团队
- 精确的GPS定位系统
- 实时风向监测设备
- 多艘标记船配合

## 实施建议

### 系统集成
在现有赛事管理系统中实现IO航线需要：
1. 支持多标记点的动态计算
2. 实时风向数据集成
3. 灵活的航线序列配置
4. 多船队位置跟踪

### 用户界面
- 清晰的标记标识系统
- 直观的航线序列显示
- 实时的船队分离状态
- 便捷的参数调整面板

## 在系统中添加IO航线

### 步骤1：创建插件文件
在 `src/features/course/plugins/` 目录下创建 `ioTrapezoid.ts` 文件：

```typescript
import L from 'leaflet';
import { destinationPoint } from '@shared/lib/geo';
import { CoursePlugin } from './CoursePlugin';
import { getCurrentLang } from 'src/locale';
import { createMarkIcon } from '../lib/markIcon';

export interface IOTrapezoidParams {
  axis: number;           // 主轴方向 (度)
  windwardDistance: number; // 迎风段距离 (海里)
  reachLength: number;     // 到达段长度 (海里)
  reachAngle: number;      // 到达段角度 (度，相对于风向)
  startLineM: number;      // 起航线长度 (米)
  courseType: 'inner' | 'outer'; // 内圈或外圈
  gateWidth: number;       // 门宽度 (米)，用于3S/3P门
}

const paramSchema = {
  axis: { type: 'number', min: 0, max: 360, step: 5 },
  windwardDistance: { type: 'number', min: 0.1, max: 2.0, step: 0.1, decimals: 1 },
  reachLength: { type: 'number', min: 0.1, max: 1.5, step: 0.1, decimals: 1 },
  reachAngle: { type: 'number', min: 45, max: 120, step: 5 },
  startLineM: { type: 'number', min: 50, max: 300, step: 10 },
  courseType: { type: 'select', options: ['inner', 'outer'] },
  gateWidth: { type: 'number', min: 20, max: 200, step: 10 },
};

export const ioTrapezoidPlugin: CoursePlugin<IOTrapezoidParams> = {
  id: 'ioTrapezoid',
  i18n: {
    zh: {
      name: 'IO梯形航线（内外圈）',
      labels: {
        axis: '主轴方向 (°)',
        windwardDistance: '迎风段距离 (海里)',
        reachLength: '到达段长度 (海里)',
        reachAngle: '到达段角度 (°)',
        startLineM: '起航线长度 (米)',
        courseType: '航线类型',
        gateWidth: '门宽度 (米)'
      },
      tooltips: {
        origin: '信号船',
        mark1: '标记1',
        mark2: '标记2',
        mark3s: '标记3S',
        mark3p: '标记3P',
        mark4: '标记4'
      }
    },
    en: {
      name: 'IO Trapezoid Course (Inner/Outer)',
      labels: {
        axis: 'Axis (°)',
        windwardDistance: 'Windward Distance (NM)',
        reachLength: 'Reach Length (NM)',
        reachAngle: 'Reach Angle (°)',
        startLineM: 'Start Line (m)',
        courseType: 'Course Type',
        gateWidth: 'Gate Width (m)'
      },
      tooltips: {
        origin: 'Signal boat',
        mark1: 'Mark 1',
        mark2: 'Mark 2',
        mark3s: 'Mark 3S',
        mark3p: 'Mark 3P',
        mark4: 'Mark 4'
      }
    }
  },
  paramSchema,
  defaultParams: {
    axis: 45,
    windwardDistance: 1.0,
    reachLength: 0.6,
    reachAngle: 60,
    startLineM: 100,
    courseType: 'outer',
    gateWidth: 50
  },
  draw: (map, origin, params, existing) => {
    const { axis, windwardDistance, reachLength, reachAngle, startLineM, courseType, gateWidth } = params;

    if (existing) {
      map.removeLayer(existing);
    }

    const group = L.featureGroup();
    const lang = getCurrentLang();
    const tooltips = ioTrapezoidPlugin.i18n![lang].tooltips;

    // 计算各标记位置
    // 标记4（参考点，在起航船左侧）
    const mark4 = destinationPoint(origin.lat, origin.lng, (axis + 270) % 360, startLineM);
    
    // 起航线中点
    const startMidLat = (origin.lat + mark4[0]) / 2;
    const startMidLng = (origin.lng + mark4[1]) / 2;
    
    // 标记1（上风标）
    const mark1 = destinationPoint(startMidLat, startMidLng, axis, windwardDistance * 1852);
    
    // 标记2（到达标）- 根据内外圈调整位置
    const reachDirection = courseType === 'outer' ? 
      (axis + reachAngle) % 360 : 
      (axis - reachAngle + 360) % 360;
    const mark2 = destinationPoint(mark1[0], mark1[1], reachDirection, reachLength * 1852);
    
    // 标记3门（下风门）- 创建3S和3P
    const mark3Center = destinationPoint(mark2[0], mark2[1], (axis + 180) % 360, windwardDistance * 1852);
    const mark3s = destinationPoint(mark3Center[0], mark3Center[1], (axis + 90) % 360, gateWidth / 2);
    const mark3p = destinationPoint(mark3Center[0], mark3Center[1], (axis + 270) % 360, gateWidth / 2);

    // 绘制线条
    const startLine = L.polyline([origin, mark4], {
      color: '#ff7f0e',
      weight: 3,
    });

    const windwardLeg = L.polyline([[startMidLat, startMidLng], mark1], {
      color: '#1f77b4',
      weight: 3,
    });

    const reachLeg = L.polyline([mark1, mark2], {
      color: '#2ca02c',
      weight: 3,
    });

    const leewardLeg = L.polyline([mark2, mark3Center], {
      color: '#1f77b4',
      weight: 3,
    });

    // 3S/3P门连线
    const gateLine = L.polyline([mark3s, mark3p], {
      color: '#9467bd',
      weight: 2,
      dashArray: '5, 5'
    });

    const finishLeg = L.polyline([mark3Center, mark4], {
      color: '#d62728',
      weight: 3,
    });

    // 创建标记
    const originMarker = L.marker(origin, { icon: createMarkIcon('S') })
      .bindTooltip(tooltips.origin);
    const mark4Marker = L.marker(mark4 as [number, number], { icon: createMarkIcon('4') })
      .bindTooltip(tooltips.mark4);
    const mark1Marker = L.marker(mark1 as [number, number], { icon: createMarkIcon('1') })
      .bindTooltip(tooltips.mark1);
    const mark2Marker = L.marker(mark2 as [number, number], { icon: createMarkIcon('2') })
      .bindTooltip(tooltips.mark2);
    const mark3sMarker = L.marker(mark3s as [number, number], { icon: createMarkIcon('3S') })
      .bindTooltip(tooltips.mark3s);
    const mark3pMarker = L.marker(mark3p as [number, number], { icon: createMarkIcon('3P') })
      .bindTooltip(tooltips.mark3p);

    // 添加到组
    group.addLayer(startLine);
    group.addLayer(windwardLeg);
    group.addLayer(reachLeg);
    group.addLayer(leewardLeg);
    group.addLayer(gateLine);
    group.addLayer(finishLeg);
    group.addLayer(originMarker);
    group.addLayer(mark4Marker);
    group.addLayer(mark1Marker);
    group.addLayer(mark2Marker);
    group.addLayer(mark3sMarker);
    group.addLayer(mark3pMarker);

    group.addTo(map);
    return group;
  },
};

export default ioTrapezoidPlugin;
```

### 步骤2：注册插件
在 `src/features/course/plugins/registry.ts` 中注册新插件：

```typescript
import { ioTrapezoidPlugin } from './ioTrapezoid';

export type CourseTypeId = 'simple' | 'simple1a' | 'oneFour' | 'ioTrapezoid' | string;

export const registry = {
  simple: simpleCoursePlugin,
  simple1a: simple1aPlugin,
  oneFour: oneFourPlugin,
  ioTrapezoid: ioTrapezoidPlugin,  // 添加这行
} as Record<CourseTypeId, CoursePlugin<any>>;
```

### 步骤3：配置参数说明

#### 关键参数含义
- **axis**: 主轴方向，即风向角度（0-360度）
- **windwardDistance**: 从起航线中点到标记1的距离（海里）
- **reachLength**: 从标记1到标记2的距离（海里），建议为迎风段距离的2/3
- **reachAngle**: 到达段相对于主轴的角度（推荐60度）
- **courseType**: 选择内圈（inner）或外圈（outer），影响标记2的位置

#### 几何关系
- 标记1位于起航线中点的正迎风方向
- 标记2的位置根据内外圈类型和到达角度计算
- 标记3位于标记2的正下风方向
- 标记4作为起航线的一端和终点参考

### 步骤4：使用建议

#### 典型配置
**外圈配置 (Outer)**:
- 主轴方向: 45°
- 迎风段距离: 1.0 海里
- 到达段长度: 0.6 海里
- 到达段角度: 60°
- 门宽度: 50 米

**内圈配置 (Inner)**:
- 主轴方向: 45°  
- 迎风段距离: 0.8 海里
- 到达段长度: 0.5 海里
- 到达段角度: 60°
- 门宽度: 50 米

#### 实时调整
- 根据风向变化调整主轴方向
- 根据水域大小调整距离参数
- 根据船队规模调整起航线长度
- 根据安全要求调整门宽度

### 实现说明

#### 技术修正
本实现对文档初始建议进行了以下改进：

1. **扩展了通用设置面板**：在 `CourseSettingsDrawer.tsx` 中添加了对 `select` 类型的支持，使航线类型选择器能正常工作。

2. **实现了3S/3P门系统**：符合世界帆联IO航线标准，通过 `gateWidth` 参数控制门的宽度，实现真正的门标记而非单一标记。

3. **修正了多语言标签**：移除了未使用的 `startMark` 标签，添加了 `mark3s` 和 `mark3p` 的正确标签。

4. **单位转换说明**：`destinationPoint` 函数的距离参数单位为米，文档中海里参数通过 `× 1852` 正确转换。

#### 航线序列实现
当前实现支持标准的IO航线序列：
- **O2**: 起航 → 1 → 2 → 3s/3p → 2 → 3p → 终点
- 3s/3p门允许船只从任一侧通过，增加战术选择

#### 视觉设计
- 起航线：橙色实线
- 迎风段：蓝色实线  
- 到达段：绿色实线
- 下风段：蓝色实线
- 门连线：紫色虚线
- 终点段：红色实线

## 规则依据

根据《帆船竞赛规则2021-2024》（Racing Rules of Sailing, RRS），IO航线作为世界帆联认可的标准赛道格式，广泛应用于国际和国内各级帆船赛事中。

---

*文档创建日期：2025-08-12*  
*最后更新：2025-08-12*